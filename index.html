<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ODA 대시보드(구글시트 연동)</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body{font-family:system-ui,Segoe UI,Arial; margin:20px;}
    .card{border:1px solid #ddd; border-radius:12px; padding:14px; max-width:900px;}
    select{padding:8px; font-size:14px;}
  </style>
</head>
<body>
  <h2>ODA 대시보드(구글시트 자동읽기)</h2>

  <div class="card">
    <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
      <div>
        <div style="font-size:12px;color:#666;margin-bottom:6px;">국가 선택</div>
        <select id="countrySelect"></select>
      </div>
      <div style="font-size:12px;color:#666;">
        ※ 구글시트 수정 후 이 페이지를 새로고침(F5)하면 값이 반영됩니다.
      </div>
    </div>

    <div style="margin-top:14px;">
      <canvas id="chart" height="120"></canvas>
    </div>
  </div>

<script>
  // ✅ 다음 단계에서 구글시트 "웹에 게시 CSV 링크"를 여기에 넣습니다
  const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSYJuhk55EpCvYR81XtF8603J3eW-UEtU2nDZ7OxvVK0mpO7a4vkdOsqUMus9bpXM9se1TETbEKPAMX/pub?output=csv";

  async function loadSheetCSV(){
    const res = await fetch(SHEET_CSV_URL);
    const text = await res.text();
    const lines = text.split(/\r?\n/).filter(l => l.trim().length > 0);

    // 첫 줄은 헤더: Country,Year,Value
    const rows = lines.slice(1);

    const data = {};
    rows.forEach(line=>{
      const [country, year, value] = line.split(",");
      if (!country) return;
      if (!data[country]) data[country] = [];
      data[country].push({ year: year?.trim(), value: parseFloat(value) });
    });

    // 연도 정렬
    Object.keys(data).forEach(c=>{
      data[c].sort((a,b)=> (a.year||"").localeCompare(b.year||""));
    });

    return data;
  }

  let chart;

  function drawChart(country, data){
    const labels = data[country].map(d=>d.year);
    const values = data[country].map(d=>d.value);

    const ctx = document.getElementById("chart").getContext("2d");

    if (chart) chart.destroy();
    chart = new Chart(ctx, {
      type: "line",
      data: {
        labels,
        datasets: [{
          label: country,
          data: values
        }]
      }
    });
  }

  (async ()=>{
    // 아직 링크를 안 넣었으면 안내
    if (SHEET_CSV_URL.includes("PASTE_YOUR")) {
      alert("아직 구글시트 CSV 링크가 없습니다.\n다음 단계에서 링크를 넣으면 대시보드가 동작합니다.");
      return;
    }

    const data = await loadSheetCSV();
    const countries = Object.keys(data);

    const sel = document.getElementById("countrySelect");
    countries.forEach(c=>{
      const opt = document.createElement("option");
      opt.value = c; opt.textContent = c;
      sel.appendChild(opt);
    });

    sel.addEventListener("change", ()=> drawChart(sel.value, data));

    if (countries.length > 0) {
      sel.value = countries[0];
      drawChart(countries[0], data);
    } else {
      alert("구글시트에 데이터가 없거나 형식이 맞지 않습니다.\n헤더는 Country,Year,Value 이어야 합니다.");
    }
  })();
</script>

</body>
</html>
